<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - Statistika</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --dark-green: #047857;
            --dark-blue: #1e40af;
            --dark-red: #b91c1c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            padding: 20px;
        }

        .container {
            max-width: 800px; /* Reduced width since we only show stats */
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background: var(--surface);
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 i { color: var(--primary); }

        /* --- FILTER SECTION --- */
        .filter-section {
            background: var(--surface);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-muted);
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:active { transform: scale(0.96); }

        /* --- STATS CARDS --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .stat-layout { grid-template-columns: 1fr; }
        }

        .stat-big-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        .stat-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 5px;
            display: block;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Mini Tables inside cards */
        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 3px 0;
            border-bottom: 1px dashed #f1f5f9;
        }

        .detail-row:last-child { border-bottom: none; }

        .detail-label { color: #64748b; }
        .detail-value { font-weight: 600; color: #334155; }

        /* Specific Colors */
        .text-cash { color: var(--dark-green); }
        .text-card { color: var(--dark-blue); }
        .bg-cash { background-color: #ecfdf5; padding: 2px 6px; border-radius: 4px; color: var(--dark-green); }
        .bg-card { background-color: #eff6ff; padding: 2px 6px; border-radius: 4px; color: var(--dark-blue); }

        /* Courier Balance Specifics */
        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            font-size: 0.9rem;
        }

        .toast.success i { color: #4ade80; }
        .toast.error i { color: #f87171; }

        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2><i class="fas fa-chart-pie"></i> Sifariş Statistikası</h2>
    </header>

    <div class="filter-section">
        <div class="form-group">
            <label for="orderDateFilter">Tarix seçin</label>
            <input type="date" id="orderDateFilter" class="form-control">
        </div>
        <button id="showOrdersButton" class="btn btn-primary" onclick="loadOrdersByDate()">
            <i class="fas fa-sync-alt"></i> Yenilə
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card" id="card-counts">
            <div style="text-align:center; padding: 40px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary)"></i>
            </div>
        </div>
        
        <div class="stat-card" id="card-sales">
            <div style="text-align:center; padding: 40px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--dark-green)"></i>
            </div>
        </div>
        
        <div class="stat-card" id="totalPerCourier">
            <div style="text-align:center; padding: 40px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--secondary)"></i>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script>
// --- CONFIGURATION ---
const API_URL = 'https://script.google.com/macros/s/AKfycbxTqcTJ1WVzDqqHsYeq2HqWU9sFJcx2SjnMEZ-g4IYvRmksEDLbPCPvSC980Vtx5xSq/exec';

// --- INITIALIZATION ---
window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('orderDateFilter').value = today;
    loadOrdersByDate(today);
};

// --- CORE FUNCTIONS ---

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
    toast.innerHTML = `${icon} <span>${message}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function loadOrdersByDate(date) {
    const selectedDate = date || document.getElementById('orderDateFilter').value;
    
    // Set loading state for cards
    const loadingHTML = '<div style="text-align:center; padding: 40px; color:#ccc;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
    document.getElementById('card-counts').innerHTML = loadingHTML;
    document.getElementById('card-sales').innerHTML = loadingHTML;
    document.getElementById('totalPerCourier').innerHTML = loadingHTML;

    fetch(`${API_URL}?action=getOrdersByDate&date=${selectedDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.orders.length > 0) {
                // Calculate and render stats
                recalculateLocalStats(data.orders);
            } else {
                // No orders found - Reset UI to zero
                updateStatsUI({
                    count: { total: 0, cash: 0, card: 0, courierCash: {}, courierCard: {}, sellerCash: {}, sellerCard: {} },
                    sales: { total: 0, cash: 0, card: 0, courierCash: {}, courierCard: {}, sellerCash: {}, sellerCard: {} }
                }, {});
                showToast('Bu tarixdə sifariş tapılmadı', 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showToast('Xəta baş verdi. İnternet əlaqəsini yoxlayın.', 'error');
        });
}

// --- LOGIC FOR UI UPDATES ---

function recalculateLocalStats(orders) {
    // 1. Prepare Detailed Data Structure
    let stats = {
        count: { 
            total: 0, cash: 0, card: 0, 
            courierCash: {}, courierCard: {}, courierTotal: {}, // Added courierTotal
            sellerCash: {}, sellerCard: {}, sellerTotal: {}     // Added sellerTotal
        },
        sales: { 
            total: 0, cash: 0, card: 0,
            courierCash: {}, courierCard: {}, courierTotal: {}, // Added courierTotal
            sellerCash: {}, sellerCard: {}, sellerTotal: {}     // Added sellerTotal
        }
    };
    let courierDebt = {};

    // 2. Process Orders
    orders.forEach(order => {
        const status = order[6];
        const amount = parseFloat(order[10]) || 0;
        const payment = (order[9] || 'cash').toLowerCase();
        let courier = order[7] || 'Digər';
        if(courier === '') courier = 'Digər';
        const seller = order[16] || 'Digər';
        const additionalPay = parseFloat(order[19]) || 0;

        // --- Active Orders (Not Canceled/Deleted) ---
        if (status !== 'Canceled' && status !== 'Deleted') {
            
            // Global Totals
            stats.count.total++;
            stats.sales.total += amount;

            // --- TRACK TOTALS (Combined Cash + Card) ---
            // Courier Totals
            stats.count.courierTotal[courier] = (stats.count.courierTotal[courier] || 0) + 1;
            stats.sales.courierTotal[courier] = (stats.sales.courierTotal[courier] || 0) + amount;

            // Seller Totals
            stats.count.sellerTotal[seller] = (stats.count.sellerTotal[seller] || 0) + 1;
            stats.sales.sellerTotal[seller] = (stats.sales.sellerTotal[seller] || 0) + amount;

            // --- TRACK BY PAYMENT METHOD ---
            if (payment === 'cash') {
                // Cash Logic
                stats.count.cash++;
                stats.sales.cash += amount;
                
                stats.count.courierCash[courier] = (stats.count.courierCash[courier] || 0) + 1;
                stats.sales.courierCash[courier] = (stats.sales.courierCash[courier] || 0) + amount;

                stats.count.sellerCash[seller] = (stats.count.sellerCash[seller] || 0) + 1;
                stats.sales.sellerCash[seller] = (stats.sales.sellerCash[seller] || 0) + amount;

            } else {
                // Card Logic
                stats.count.card++;
                stats.sales.card += amount;

                stats.count.courierCard[courier] = (stats.count.courierCard[courier] || 0) + 1;
                stats.sales.courierCard[courier] = (stats.sales.courierCard[courier] || 0) + amount;

                stats.count.sellerCard[seller] = (stats.count.sellerCard[seller] || 0) + 1;
                stats.sales.sellerCard[seller] = (stats.sales.sellerCard[seller] || 0) + amount;
            }
        }

        // --- Courier Balance Logic (Debt) ---
        if (courier !== 'Digər' && (status === 'Delivered' || status === 'Canceled')) {
            if (!courierDebt[courier]) courierDebt[courier] = { net: 0, cardTotal: 0 };
            
            // Deduct Courier Fee & Bonus (Company owes courier this money)
            courierDebt[courier].net -= 5.8; 
            courierDebt[courier].net -= additionalPay;

            // If Delivered:
            if (status === 'Delivered') {
                if (payment === 'cash') {
                    // Courier holds cash -> They owe company
                    courierDebt[courier].net += amount; 
                } else {
                    // Money went to bank -> Just track it for info
                    courierDebt[courier].cardTotal += amount;
                }
            }
        }
    });

    updateStatsUI(stats, courierDebt);
}

    function updateStatsUI(stats, courierDebt) {

    // --- Helper: Generate HTML rows for the breakdown ---
    const generateRows = (dataObj, isCurrency) => {
        const sortedKeys = Object.keys(dataObj).sort((a,b) => dataObj[b] - dataObj[a]);
        if(sortedKeys.length === 0) return '<div style="font-size:0.7rem; color:#ccc; padding:5px 0;">Məlumat yoxdur</div>';
        
        return sortedKeys.map(key => {
            const val = dataObj[key];
            const display = isCurrency ? val.toFixed(2) + ' ₼' : val;
            return `
                <div class="detail-row">
                    <span class="detail-label">${key}</span>
                    <span class="detail-value">${display}</span>
                </div>`;
        }).join('');
    };

    // --- CARD 1: ORDER COUNTS (Detailed) ---
    const card1 = `
        <span class="stat-header">Ümumi Sifariş Statistikası</span>
        <div class="stat-layout">
            <div style="text-align:center; padding-right:15px; border-right:1px solid #eee;">
                <div class="stat-big-number" style="color:var(--primary)">${stats.count.total}</div>
                <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">Toplam Sifariş</div>
                <div style="margin-top:15px; text-align:left; font-size:0.8rem;">
                     <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span><i class="fas fa-money-bill text-cash"></i> Nağd:</span> 
                        <b>${stats.count.cash}</b>
                     </div>
                     <div style="display:flex; justify-content:space-between;">
                        <span><i class="fas fa-credit-card text-card"></i> Kart:</span> 
                        <b>${stats.count.card}</b>
                     </div>
                </div>
            </div>

            <div>
                <div class="section-title text-cash"><i class="fas fa-wallet"></i> Nağd</div>
                <div style="margin-bottom:8px;">
                    ${generateRows(stats.count.courierCash, false)}
                </div>
                <div class="section-title text-card" style="margin-top:10px;"><i class="fas fa-credit-card"></i> Kart</div>
                <div style="margin-bottom:8px;">
                    ${generateRows(stats.count.courierCard, false)}
                </div>
            </div>

            <div>
                <div class="section-title" style="color:var(--text); border-color:var(--primary);">
                    <i class="fas fa-users"></i> Ümumi (Hamısı)
                </div>
                <div style="margin-bottom:8px;">
                    <small style="font-weight:700; color:#94a3b8; font-size:0.65rem;">KURYERLƏR (YEKUN)</small>
                    ${generateRows(stats.count.courierTotal, false)}
                </div>
                <div>
                    <small style="font-weight:700; color:#94a3b8; font-size:0.65rem;">SATIŞ TƏMSİLÇİSİ (YEKUN)</small>
                    ${generateRows(stats.count.sellerTotal, false)}
                </div>
            </div>
        </div>
    `;

    // --- CARD 2: SALES REVENUE (Detailed) ---
    const card2 = `
        <span class="stat-header">Maliyyə Hesabatı (Gəlir)</span>
        <div class="stat-layout">
            <div style="text-align:center; padding-right:15px; border-right:1px solid #eee;">
                <div class="stat-big-number" style="color:var(--dark-green)">${stats.sales.total.toFixed(0)}<span style="font-size:1rem">₼</span></div>
                <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">Ümumi Dövriyyə</div>
                
                 <div style="margin-top:15px; text-align:left; font-size:0.8rem;">
                     <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span><i class="fas fa-money-bill text-cash"></i> Nağd:</span> 
                        <span class="bg-cash">${stats.sales.cash.toFixed(0)} ₼</span>
                     </div>
                     <div style="display:flex; justify-content:space-between;">
                        <span><i class="fas fa-credit-card text-card"></i> Kart:</span> 
                        <span class="bg-card">${stats.sales.card.toFixed(0)} ₼</span>
                     </div>
                </div>
            </div>

            <div>
                <div class="section-title text-cash"><i class="fas fa-coins"></i> Nağd</div>
                <div style="margin-bottom:8px;">
                    ${generateRows(stats.sales.courierCash, true)}
                </div>
                <div class="section-title text-card" style="margin-top:10px;"><i class="fas fa-university"></i> Kart</div>
                <div style="margin-bottom:8px;">
                    ${generateRows(stats.sales.courierCard, true)}
                </div>
            </div>

            <div>
                 <div class="section-title" style="color:var(--text); border-color:var(--dark-green);">
                    <i class="fas fa-chart-line"></i> Ümumi (Hamısı)
                </div>
                <div style="margin-bottom:8px;">
                    <small style="font-weight:700; color:#94a3b8; font-size:0.65rem;">KURYERLƏR (YEKUN)</small>
                    ${generateRows(stats.sales.courierTotal, true)}
                </div>
                <div>
                    <small style="font-weight:700; color:#94a3b8; font-size:0.65rem;">SATIŞ TƏMSİLÇİSİ (YEKUN)</small>
                    ${generateRows(stats.sales.sellerTotal, true)}
                </div>
            </div>
        </div>
    `;

    // --- CARD 3: COURIER DEBT (Visual List) ---
    // (This part remains unchanged, but included for completeness)
    let debtRows = '';
    let totalDebt = 0;
    
    // Sort couriers: Debtors (Red) first, then Creditors (Green)
    const sortedCouriers = Object.entries(courierDebt).sort((a,b) => b[1].net - a[1].net);

    sortedCouriers.forEach(([name, data]) => {
        totalDebt += data.net;
        const isDebt = data.net > 0;
        const color = isDebt ? 'var(--dark-red)' : 'var(--dark-green)';
        const label = isDebt ? 'Kassaya borcludur' : 'Kassa borcludur';
        
        debtRows += `
            <div class="balance-row" style="border-left: 3px solid ${color}">
                <div>
                    <div style="font-weight:700; font-size:0.9rem;">${name}</div>
                    <div style="font-size:0.7rem; color:#94a3b8;">
                        <i class="fas fa-credit-card"></i> Kart dövriyyə: ${data.cardTotal.toFixed(2)} ₼
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:800; color:${color}; font-size:1rem;">
                        ${data.net.toFixed(2)} ₼
                    </div>
                    <div style="font-size:0.65rem; color:${color}; opacity:0.8;">${label}</div>
                </div>
            </div>
        `;
    });


    const totalDebtColor = totalDebt > 0 ? 'var(--dark-red)' : 'var(--dark-green)';
    const card3 = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span class="stat-header" style="margin:0;">Kuryer Balansı (Net)</span>
            <span class="bg-card" style="font-weight:700; color:${totalDebtColor}; font-size:1rem;">
                YEKUN: ${totalDebt.toFixed(2)} ₼
            </span>
        </div>
        
        <div style="max-height: 300px; overflow-y: auto;">
            ${debtRows || '<div style="padding:10px; text-align:center;">Məlumat yoxdur</div>'}
        </div>
    `;

    // Inject HTML
    document.getElementById('card-counts').innerHTML = card1;
    document.getElementById('card-sales').innerHTML = card2;
    document.getElementById('totalPerCourier').innerHTML = card3;
}
</script>

</body>
</html>
